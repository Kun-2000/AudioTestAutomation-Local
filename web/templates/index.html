<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>自動化測試錄音功能系統</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

      :root {
        --primary-gradient: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
        --secondary-gradient: linear-gradient(135deg, #00cec9 0%, #55a3ff 100%);
        --success-gradient: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
        --warning-gradient: linear-gradient(135deg, #fdcb6e 0%, #e84393 100%);
        --danger-gradient: linear-gradient(135deg, #e84393 0%, #fd79a8 100%);
        --bg-gradient: linear-gradient(
          135deg,
          #0a0a0a 0%,
          #1a1a2e 50%,
          #16213e 100%
        );
        --glass-bg: rgba(0, 212, 170, 0.08);
        --glass-border: rgba(0, 212, 170, 0.15);
        --shadow-light: 0 8px 32px rgba(0, 212, 170, 0.1);
        --shadow-medium: 0 12px 40px rgba(0, 212, 170, 0.15);
        --shadow-heavy: 0 20px 60px rgba(0, 212, 170, 0.2);
        --text-primary: #ffffff;
        --text-secondary: #a0a0a0;
        --text-light: rgba(255, 255, 255, 0.9);
        --text-dim: rgba(255, 255, 255, 0.7);
        --accent-green: #00d4aa;
        --accent-cyan: #00cec9;
        --border-radius: 16px;
        --border-radius-sm: 8px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      [data-theme="light"] {
        --bg-gradient: linear-gradient(
          135deg,
          #f7f9fc 0%,
          #e8f5e9 50%,
          #e0f2f1 100%
        );
        --glass-bg: rgba(0, 212, 170, 0.05);
        --glass-border: rgba(0, 212, 170, 0.1);
        --shadow-light: 0 8px 32px rgba(0, 212, 170, 0.08);
        --shadow-medium: 0 12px 40px rgba(0, 212, 170, 0.12);
        --shadow-heavy: 0 20px 60px rgba(0, 212, 170, 0.15);
        --text-primary: #2c3e50;
        --text-secondary: #7f8c8d;
        --text-light: rgba(44, 62, 80, 0.9);
        --text-dim: rgba(44, 62, 80, 0.7);
      }

      .no-bullets ul {
        list-style-type: none;
        padding-left: 0;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        transition: color 0.3s ease, background-color 0.3s ease,
          border-color 0.3s ease;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg-gradient);
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* 背景動畫 */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            circle at 20% 80%,
            rgba(0, 212, 170, 0.15) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 20%,
            rgba(0, 206, 201, 0.1) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 40% 40%,
            rgba(85, 163, 255, 0.08) 0%,
            transparent 50%
          );
        animation: float 20s ease-in-out infinite;
        z-index: -1;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px) rotate(0deg);
        }
        33% {
          transform: translateY(-20px) rotate(1deg);
        }
        66% {
          transform: translateY(10px) rotate(-1deg);
        }
      }

      /* 浮動粒子背景 */
      .floating-particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        pointer-events: none;
        z-index: -1;
      }

      .particle {
        position: absolute;
        background: rgba(0, 212, 170, 0.1);
        border-radius: 50%;
        animation: float-particle 15s infinite linear;
      }

      @keyframes float-particle {
        0% {
          transform: translateY(100vh) rotate(0deg);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          transform: translateY(-100px) rotate(360deg);
          opacity: 0;
        }
      }

      /* 主題切換器 */
      .theme-toggle-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 12px;
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        padding: 8px 16px;
        border-radius: 50px;
        border: 1px solid var(--glass-border);
        transition: var(--transition);
        box-shadow: var(--shadow-light);
      }

      .theme-toggle-container:hover {
        background: rgba(0, 212, 170, 0.12);
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
      }

      .theme-toggle {
        position: relative;
        width: 60px;
        height: 30px;
        background: linear-gradient(
          45deg,
          rgba(0, 0, 0, 0.3),
          rgba(45, 45, 45, 0.3)
        );
        border-radius: 30px;
        border: 2px solid var(--accent-green);
        cursor: pointer;
        transition: var(--transition);
        overflow: hidden;
        box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .theme-toggle::before {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 22px;
        height: 22px;
        background: var(--primary-gradient);
        border-radius: 50%;
        transition: var(--transition);
        box-shadow: 0 0 15px rgba(0, 212, 170, 0.6),
          0 0 30px rgba(0, 212, 170, 0.4),
          inset 0 2px 4px rgba(255, 255, 255, 0.3);
      }

      .theme-toggle.dark {
        background: var(--primary-gradient);
        border-color: #ffffff;
        box-shadow: 0 0 20px rgba(0, 212, 170, 0.4);
      }

      .theme-toggle.dark::before {
        transform: translateX(28px);
        background: linear-gradient(135deg, #ffffff, #f0f0f0);
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.8),
          0 0 30px rgba(255, 255, 255, 0.4);
      }

      .theme-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--accent-green);
        text-transform: uppercase;
        letter-spacing: 1px;
        text-shadow: 0 0 10px rgba(0, 212, 170, 0.5);
      }

      /* 主要布局容器 */
      .main-container {
        display: grid;
        grid-template-rows: auto 1fr;
        gap: 20px;
        padding: 20px;
        min-height: 100vh;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* 上方架構圖區域 */
      .architecture-panel {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: var(--border-radius);
        padding: 15px 30px;
        box-shadow: var(--shadow-medium);
        animation: slideInTop 0.6s ease;
        position: sticky;
        top: 10px; /* 距離頂部 10px，避免貼邊 */
        z-index: 100; /* 確保它會顯示在其他內容之上 */
      }

      .architecture-title {
        text-align: center;
        margin-bottom: 30px;
        font-size: 1.2em;
        font-weight: 700;
        color: var(--accent-green);
        border-bottom: 2px solid var(--accent-green);
        padding-bottom: 10px;
      }

      /* 系統架構流程 - 水平佈局（圓圈設計） */
      .architecture-flow {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-wrap: nowrap;
        gap: 12px;
        overflow-x: auto;
        padding: 20px 0;
      }

      /* 系統圓圈樣式 - 修改為圓形 */
      .system-circle {
        min-width: 110px;
        width: 110px;
        height: 110px;
        background: var(--glass-bg);
        backdrop-filter: blur(15px);
        border: 2px solid var(--glass-border);
        border-radius: 50%; /* 圓形 */
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: 12px;
        font-weight: 600;
        position: relative;
        transition: var(--transition);
        cursor: pointer;
        box-shadow: var(--shadow-light);
        flex-shrink: 0;
        padding: 10px; /* 確保文字不會貼邊 */
      }

      .system-circle::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          45deg,
          transparent 30%,
          rgba(0, 212, 170, 0.05) 50%,
          transparent 70%
        );
        border-radius: 50%;
        opacity: 0;
        transition: var(--transition);
      }

      .system-circle:hover::before {
        opacity: 1;
      }

      .system-circle.idle {
        border-color: rgba(160, 160, 160, 0.3);
        color: var(--text-secondary);
        background: rgba(160, 160, 160, 0.05);
      }

      .system-circle.active {
        border-color: var(--accent-green);
        color: var(--accent-green);
        background: rgba(0, 212, 170, 0.12);
        box-shadow: 0 0 30px rgba(0, 212, 170, 0.3), var(--shadow-medium);
        animation: pulse-glow 2s infinite;
      }

      .system-circle.completed {
        border-color: var(--accent-green);
        color: var(--accent-green);
        background: rgba(0, 212, 170, 0.08);
        box-shadow: var(--shadow-light);
      }

      .system-circle.completed::after {
        content: "✓";
        position: absolute;
        top: -8px;
        right: -8px;
        width: 20px;
        height: 20px;
        background: var(--primary-gradient);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: white;
        font-weight: bold;
        border: 2px solid var(--accent-green);
      }

      @keyframes pulse-glow {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(0, 212, 170, 0.3), var(--shadow-medium);
          transform: scale(1);
        }
        50% {
          box-shadow: 0 0 40px rgba(0, 212, 170, 0.5), var(--shadow-medium);
          transform: scale(1.02);
        }
      }

      /* 流程箭頭 - 水平方向 */
      .flow-arrow {
        width: 40px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        flex-shrink: 0;
      }

      .arrow-line {
        width: 40px;
        height: 2px;
        background: var(--glass-border);
        position: relative;
        transition: var(--transition);
      }

      .arrow-head {
        position: absolute;
        right: -2px;
        width: 0;
        height: 0;
        border-top: 6px solid transparent;
        border-bottom: 6px solid transparent;
        border-left: 8px solid var(--glass-border);
        transition: var(--transition);
      }

      .flow-arrow.idle .arrow-line,
      .flow-arrow.idle .arrow-head {
        background: rgba(160, 160, 160, 0.3);
        border-left-color: rgba(160, 160, 160, 0.3);
      }

      .flow-arrow.active .arrow-line {
        background: var(--accent-green);
        box-shadow: 0 0 10px rgba(0, 212, 170, 0.5);
        animation: flow-animation-horizontal 1.5s infinite;
      }

      .flow-arrow.active .arrow-head {
        border-left-color: var(--accent-green);
        filter: drop-shadow(0 0 8px rgba(0, 212, 170, 0.5));
        animation: pulse-arrow 1.5s infinite;
      }

      .flow-arrow.completed .arrow-line {
        background: var(--accent-green);
        box-shadow: 0 0 8px rgba(0, 212, 170, 0.3);
      }

      .flow-arrow.completed .arrow-head {
        border-left-color: var(--accent-green);
      }

      @keyframes flow-animation-horizontal {
        0% {
          background: linear-gradient(
            90deg,
            transparent 0%,
            var(--accent-green) 50%,
            transparent 100%
          );
        }
        50% {
          background: linear-gradient(
            90deg,
            var(--accent-green) 0%,
            transparent 50%,
            var(--accent-green) 100%
          );
        }
        100% {
          background: linear-gradient(
            90deg,
            transparent 0%,
            var(--accent-green) 50%,
            transparent 100%
          );
        }
      }

      @keyframes pulse-arrow {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
      }

      .system-circle.start-end {
        background: rgba(0, 206, 201, 0.1);
        border-color: var(--accent-cyan);
        font-weight: 700;
      }

      .system-circle.start-end.active {
        border-color: var(--accent-cyan);
        color: var(--accent-cyan);
        box-shadow: 0 0 30px rgba(0, 206, 201, 0.4), var(--shadow-medium);
      }

      .system-circle.start-end.completed {
        border-color: var(--accent-cyan);
        color: var(--accent-cyan);
      }

      /* 下方控制面板 */
      .control-panel {
        display: flex;
        flex-direction: column;
        gap: 20px;
        animation: slideInBottom 0.6s ease;
      }

      @keyframes slideInTop {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideInBottom {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* 7步驟操作區塊 */
      .step-section {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: var(--border-radius);
        margin-bottom: 15px;
        box-shadow: var(--shadow-light);
        position: relative;
        overflow: hidden;
        transition: var(--transition);
      }

      .step-section::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          45deg,
          transparent 30%,
          rgba(0, 212, 170, 0.03) 50%,
          transparent 70%
        );
        transform: translateX(-100%);
        transition: transform 0.6s ease;
      }

      .step-section:hover::before {
        transform: translateX(100%);
      }

      .step-section:hover {
        border-color: rgba(0, 212, 170, 0.3);
        box-shadow: var(--shadow-medium);
        transform: translateY(-2px);
      }

      /* 步驟標題區 */
      .step-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 25px;
        border-bottom: 1px solid var(--glass-border);
        cursor: pointer;
      }

      .step-title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1.1em;
        font-weight: 600;
        color: var(--text-primary);
      }

      .step-number {
        width: 28px;
        height: 28px;
        background: var(--glass-bg);
        border: 2px solid var(--glass-border);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 700;
        transition: var(--transition);
      }

      .step-status {
        font-size: 12px;
        padding: 4px 12px;
        border-radius: 12px;
        font-weight: 500;
        transition: var(--transition);
      }

      .step-status.idle {
        background: rgba(160, 160, 160, 0.1);
        color: var(--text-secondary);
      }

      .step-status.active {
        background: rgba(0, 212, 170, 0.2);
        color: var(--accent-green);
        animation: pulse 2s infinite;
      }

      .step-status.completed {
        background: rgba(0, 212, 170, 0.2);
        color: var(--accent-green);
      }

      /* 步驟內容區 */
      .step-content {
        padding: 0;
        max-height: 0;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .step-section.minimized .step-content {
        max-height: 0;
        padding: 0;
      }

      .step-section.expanded .step-content {
        max-height: 800px;
        padding: 25px;
      }

      .step-section.summary .step-content {
        max-height: 1600px;
        padding: 15px 25px;
      }

      /* 步驟狀態對應的視覺效果 */
      .step-section.step-idle {
        opacity: 0.6;
      }

      .step-section.step-idle .step-number {
        border-color: rgba(160, 160, 160, 0.3);
        color: var(--text-secondary);
      }

      .step-section.step-active {
        border-color: rgba(0, 212, 170, 0.4);
        box-shadow: 0 0 20px rgba(0, 212, 170, 0.2);
      }

      .step-section.step-active .step-number {
        border-color: var(--accent-green);
        background: rgba(0, 212, 170, 0.2);
        color: var(--accent-green);
      }

      .step-section.step-completed .step-number {
        border-color: var(--accent-green);
        background: var(--accent-green);
        color: white;
      }

      .step-section.step-completed .step-number::after {
        content: "✓";
        font-size: 10px;
      }

      /* 其他樣式保持原樣 */
      h1 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 2.2em;
        font-weight: 700;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 2px 20px rgba(0, 212, 170, 0.3);
        grid-column: 1 / -1;
      }

      .textarea-container {
        position: relative;
        margin-bottom: 15px;
      }

      textarea {
        width: 100%;
        height: 200px;
        padding: 16px;
        border: 2px solid var(--glass-border);
        border-radius: var(--border-radius-sm);
        font-size: 14px;
        font-family: "SF Mono", "Courier New", monospace;
        resize: vertical;
        background: rgba(0, 212, 170, 0.03);
        color: var(--text-primary);
        transition: var(--transition);
        backdrop-filter: blur(10px);
      }

      textarea:focus {
        outline: none;
        border-color: rgba(0, 212, 170, 0.4);
        background: rgba(0, 212, 170, 0.08);
        box-shadow: 0 0 30px rgba(0, 212, 170, 0.2);
        transform: translateY(-2px);
      }

      textarea::placeholder {
        color: var(--text-dim);
      }

      .textarea-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
        font-size: 12px;
        color: var(--text-dim);
      }

      .char-count {
        font-weight: 500;
        color: var(--accent-green);
      }

      .drag-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 212, 170, 0.15);
        border: 2px dashed var(--accent-green);
        border-radius: var(--border-radius-sm);
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: var(--accent-green);
        font-weight: 600;
        pointer-events: none;
        z-index: 10;
        backdrop-filter: blur(10px);
      }

      .drag-overlay.active {
        display: flex;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      button {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        color: var(--accent-green);
        padding: 14px 28px;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(15px);
        box-shadow: var(--shadow-light);
      }

      button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(0, 212, 170, 0.1),
          transparent
        );
        transition: left 0.5s ease;
      }

      button:hover:not(:disabled) {
        background: rgba(0, 212, 170, 0.12);
        transform: translateY(-3px);
        box-shadow: var(--shadow-medium);
        border-color: rgba(0, 212, 170, 0.3);
      }

      button:hover:not(:disabled)::before {
        left: 100%;
      }

      button:disabled {
        background: rgba(160, 160, 160, 0.05);
        color: var(--text-secondary);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        border-color: rgba(160, 160, 160, 0.1);
      }

      .status,
      .result-box {
        padding: 20px;
        border-radius: var(--border-radius-sm);
        margin: 20px 0;
        border: 1px solid;
        transition: var(--transition);
        animation: fadeIn 0.5s ease;
        backdrop-filter: blur(15px);
        box-shadow: var(--shadow-light);
        position: relative;
        overflow: hidden;
      }

      .status-success {
        background: rgba(0, 212, 170, 0.1);
        color: var(--accent-green);
        border-color: rgba(0, 212, 170, 0.3);
      }

      .status-error {
        background: rgba(232, 67, 147, 0.1);
        color: #e84393;
        border-color: rgba(232, 67, 147, 0.3);
        animation: shake 0.5s ease;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      .status-info {
        background: rgba(0, 206, 201, 0.1);
        color: var(--accent-cyan);
        border-color: rgba(0, 206, 201, 0.3);
      }

      .result-box {
        background: var(--glass-bg);
        border-color: var(--glass-border);
        color: var(--text-primary);
      }

      .score {
        font-size: 2.2em;
        font-weight: 700;
        text-align: center;
        padding: 30px;
        border-radius: var(--border-radius);
        margin-bottom: 25px;
        position: relative;
        overflow: hidden;
        animation: slideInUp 0.8s ease;
        backdrop-filter: blur(20px);
        box-shadow: var(--shadow-heavy);
      }

      .score-excellent {
        background: var(--success-gradient);
        color: white;
        border: 1px solid rgba(0, 212, 170, 0.3);
      }
      .score-good {
        background: var(--secondary-gradient);
        color: white;
        border: 1px solid rgba(0, 206, 201, 0.3);
      }
      .score-fair {
        background: var(--warning-gradient);
        color: white;
        border: 1px solid rgba(253, 203, 110, 0.3);
      }
      .score-poor {
        background: var(--danger-gradient);
        color: white;
        border: 1px solid rgba(232, 67, 147, 0.3);
      }

      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0, 212, 170, 0.3);
        border-radius: 50%;
        border-top-color: var(--accent-green);
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .progress-bar {
        width: 100%;
        height: 6px;
        background: rgba(0, 212, 170, 0.1);
        border-radius: 3px;
        overflow: hidden;
        margin: 15px 0;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0, 212, 170, 0.2);
      }

      .progress-fill {
        height: 100%;
        background: var(--primary-gradient);
        border-radius: 3px;
        transition: width 0.3s ease;
        position: relative;
        box-shadow: 0 0 20px rgba(0, 212, 170, 0.4);
      }

      .progress-fill::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.4),
          transparent
        );
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .skeleton {
        background: linear-gradient(
          90deg,
          rgba(0, 212, 170, 0.05) 25%,
          rgba(0, 212, 170, 0.15) 50%,
          rgba(0, 212, 170, 0.05) 75%
        );
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: var(--border-radius-sm);
        backdrop-filter: blur(10px);
      }

      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      .skeleton-line {
        height: 16px;
        margin: 8px 0;
      }
      .skeleton-title {
        height: 24px;
        width: 60%;
        margin: 16px 0;
      }

      .log-item {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding: 16px;
        background: var(--glass-bg);
        border-radius: var(--border-radius-sm);
        transition: var(--transition);
        animation: fadeIn 0.6s ease;
        backdrop-filter: blur(15px);
        border: 1px solid var(--glass-border);
        box-shadow: var(--shadow-light);
        position: relative;
        overflow: hidden;
      }

      .log-item::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 3px;
        height: 100%;
        background: var(--primary-gradient);
      }

      .log-item:hover {
        transform: translateX(5px);
        box-shadow: var(--shadow-medium);
        border-color: rgba(0, 212, 170, 0.3);
      }

      .log-icon {
        font-size: 28px;
        margin-right: 16px;
        transition: transform 0.3s ease;
        filter: drop-shadow(0 2px 8px rgba(0, 212, 170, 0.3));
      }

      .log-item:hover .log-icon {
        transform: scale(1.1) rotate(5deg);
      }

      .log-content {
        flex-grow: 1;
      }

      .log-title {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 4px;
        color: var(--text-primary);
      }

      .log-detail {
        font-size: 14px;
        color: var(--text-dim);
      }

      audio {
        width: 100%;
        margin-top: 12px;
        border-radius: var(--border-radius-sm);
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
      }

      .hidden {
        display: none;
      }
      .fade-enter {
        animation: fadeIn 0.5s ease;
      }

      .toast {
        position: fixed;
        top: 20px;
        right: 100px;
        padding: 12px 20px;
        border-radius: var(--border-radius-sm);
        color: white;
        font-weight: 500;
        z-index: 1000;
        animation: slideInRight 0.3s ease;
        backdrop-filter: blur(20px);
        box-shadow: var(--shadow-medium);
        border: 1px solid;
      }

      .toast-success {
        background: rgba(0, 212, 170, 0.9);
        border-color: rgba(0, 212, 170, 0.3);
      }

      .toast-error {
        background: rgba(232, 67, 147, 0.9);
        border-color: rgba(232, 67, 147, 0.3);
      }

      .toast-info {
        background: rgba(0, 206, 201, 0.9);
        border-color: rgba(0, 206, 201, 0.3);
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(100px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .shortcut-hint {
        font-size: 11px;
        color: var(--text-dim);
        margin-top: 4px;
      }

      .progress-stage {
        text-align: center;
        font-size: 12px;
        color: var(--accent-green);
        margin-top: 8px;
        font-weight: 500;
        opacity: 0.8;
        transition: var(--transition);
      }

      .auto-save-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--accent-green);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .auto-save-indicator.visible {
        opacity: 1;
      }

      /* 響應式設計 */
      @media (max-width: 1200px) {
        .architecture-flow {
          overflow-x: auto;
          padding: 20px 10px;
        }

        .system-circle {
          min-width: 100px;
          width: 100px;
          height: 100px;
          font-size: 11px;
        }

        .flow-arrow {
          min-width: 40px;
          width: 40px;
        }
      }

      @media (max-width: 768px) {
        .main-container {
          padding: 10px;
          gap: 15px;
        }

        .architecture-panel {
          padding: 20px;
        }

        .step-section {
          margin-bottom: 10px;
        }

        .step-header {
          padding: 15px 20px;
        }

        .step-content {
          padding: 20px;
        }

        h1 {
          font-size: 1.8em;
        }

        .theme-toggle-container {
          top: 10px;
          right: 10px;
          padding: 6px 12px;
          transform: scale(0.9);
        }

        textarea {
          height: 150px;
        }

        button {
          padding: 12px 20px;
        }

        .system-circle {
          height: 80px;
          font-size: 10px;
          min-width: 80px;
          width: 80px;
        }

        .architecture-flow {
          overflow-x: auto;
          flex-direction: row;
          justify-content: flex-start;
          align-items: center;
        }

        .flow-arrow {
          transform: none;
          width: 30px;
          height: 30px;
        }
      }

      @keyframes slideInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <!-- 浮動粒子背景 -->
    <div class="floating-particles" id="particles"></div>

    <!-- 主題切換器 -->
    <div class="theme-toggle-container">
      <div class="theme-toggle" onclick="toggleTheme()" id="themeToggle"></div>
      <div class="theme-label" id="themeLabel">DARK</div>
    </div>

    <!-- 主標題 -->
    <h1>自動化測試錄音功能系統</h1>

    <!-- 主要布局容器 -->
    <div class="main-container">
      <!-- 上方架構圖面板 -->
      <div class="architecture-panel">
        <div class="architecture-title">系統架構流程圖</div>

        <div class="architecture-flow">
          <!-- 圓圈 1: 測試對話腳本 -->
          <div class="system-circle idle" id="circle-preprocessing">
            測試對話腳本
          </div>

          <!-- 箭頭 1 -->
          <div class="flow-arrow idle" id="arrow-1">
            <div class="arrow-line"></div>
            <div class="arrow-head"></div>
          </div>

          <!-- 圓圈 2: 系統啟動 -->
          <div class="system-circle start-end idle" id="circle-startup">
            系統啟動
          </div>

          <!-- 箭頭 2 -->
          <div class="flow-arrow idle" id="arrow-2">
            <div class="arrow-line"></div>
            <div class="arrow-head"></div>
          </div>

          <!-- 圓圈 3: 客服系統 -->
          <div class="system-circle idle" id="circle-tts-conversion">
            客服系統
          </div>

          <!-- 箭頭 3 -->
          <div class="flow-arrow idle" id="arrow-3">
            <div class="arrow-line"></div>
            <div class="arrow-head"></div>
          </div>

          <!-- 圓圈 4: 錄音系統 -->
          <div class="system-circle idle" id="circle-recording">
            錄音系統
          </div>

          <!-- 箭頭 4 -->
          <div class="flow-arrow idle" id="arrow-4">
            <div class="arrow-line"></div>
            <div class="arrow-head"></div>
          </div>

          <!-- 圓圈 5: 音檔存放系統 -->
          <div class="system-circle idle" id="circle-storage">
            音檔存放系統
          </div>

          <!-- 箭頭 5 -->
          <div class="flow-arrow idle" id="arrow-5">
            <div class="arrow-line"></div>
            <div class="arrow-head"></div>
          </div>

          <!-- 圓圈 6: 分析系統 -->
          <div class="system-circle idle" id="circle-llm-analysis">
            分析系統
          </div>

          <!-- 箭頭 6 -->
          <div class="flow-arrow idle" id="arrow-6">
            <div class="arrow-line"></div>
            <div class="arrow-head"></div>
          </div>

          <!-- 圓圈 7: 系統結束 -->
          <div class="system-circle start-end idle" id="circle-completion">
            系統結束
          </div>
        </div>
      </div>

      <!-- 下方控制面板 - 7個步驟完全展開 -->
      <div class="control-panel">
        
        <!-- 步驟1：測試對話腳本 -->
        <div class="step-section step-idle expanded" id="step-preprocessing">
          <div class="step-header" onclick="toggleStepContent('preprocessing')">
            <div class="step-title">
              <div class="step-number">1</div>
              <span>📝 測試對話腳本</span>
            </div>
            <div class="step-status idle">待機中</div>
          </div>
          <div class="step-content">
            <div class="textarea-container">
              <textarea
                id="testScript"
                placeholder="請輸入測試腳本或拖拽文字檔案至此..."
              >
客戶: 你好，我想詢問產品資訊。
客服: 很高興為您服務，請問需要什麼協助？
客戶: 我想了解你們的保險產品。
客服: 好的，我來為您介紹我們的主要保險商品。</textarea
              >
              <div class="drag-overlay" id="dragOverlay">
                📄 放開以載入文字檔案
              </div>
            </div>
            <div class="textarea-footer">
              <div>
                <span class="char-count" id="charCount">0 字元</span>
                <span class="dialogue-count" id="dialogueCount">0 行對話</span>
                <span class="auto-save-indicator" id="autoSaveIndicator">
                  💾 已自動儲存
                </span>
              </div>
            </div>
            <div id="scriptValidation" class="hidden"></div>
            <div style="text-align: center; margin-top: 15px;">
              <button onclick="scrollToStep('startup')">
              腳本輸入完成
              </button>
            </div>
            
          </div>
        </div>

        <!-- 步驟2：系統啟動 -->
        <div class="step-section step-idle minimized" id="step-startup">
          <div class="step-header" onclick="toggleStepContent('startup')">
            <div class="step-title">
              <div class="step-number">2</div>
              <span>🚀 系統啟動</span>
            </div>
            <div class="step-status idle">待機中</div>
          </div>
          <div class="step-content" style="text-align: center;">
            <button onclick="startTest()" id="startTestBtn">開始測試</button>
            <div class="result-box" style="margin-top: 15px; text-align: left;">
              <h4>API 連線狀態</h4>
              <div id="apiStatusGrid">
                <div class="log-item">
                  <div class="log-icon">🎵</div>
                  <div class="log-content">
                    <div class="log-title">TTS API</div>
                    <div class="log-detail" id="ttsApiStatus">等待檢查...</div>
                  </div>
                </div>
                <div class="log-item">
                  <div class="log-icon">🎤</div>
                  <div class="log-content">
                    <div class="log-title" id="sttApiTitle">STT API</div>
                    <div class="log-detail" id="sttApiStatus">等待檢查...</div>
                  </div>
                </div>
                <div class="log-item">
                  <div class="log-icon">🤖</div>
                  <div class="log-content">
                    <div class="log-title" id="llmApiTitle">LLM API</div>
                    <div class="log-detail" id="llmApiStatus">等待檢查...</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="startupStatus" class="hidden"></div>
          </div>
        </div>

        <!-- 步驟3：客服系統 -->
        <div class="step-section step-idle minimized" id="step-tts-conversion">
          <div class="step-header" onclick="toggleStepContent('tts-conversion')">
            <div class="step-title">
              <div class="step-number">3</div>
              <span>🎵 客服系統</span>
            </div>
            <div class="step-status idle">待機中</div>
          </div>
          <div class="step-content">
            <div class="result-box">
              <h4>TTS 生成對話音檔</h4>
              <div id="ttsSkeletonLoader" class="skeleton-line hidden"></div>
              <audio id="ttsAudioPlayer" controls class="hidden"></audio>
              <div id="ttsAudioInfo" class="hidden" style="margin-top: 10px; font-size: 12px; color: var(--text-dim);">
                <span id="ttsAudioDuration">時長: --</span> | 
                <span id="ttsAudioSize">大小: --</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 步驟4：錄音系統 -->
        <div class="step-section step-idle minimized" id="step-recording">
          <div class="step-header" onclick="toggleStepContent('recording')">
            <div class="step-title">
              <div class="step-number">4</div>
              <span>🎙️ 錄音系統</span>
            </div>
            <div class="step-status idle">待機中</div>
          </div>
          <div class="step-content">
            <div class="result-box">
              <h4>模擬系統錄音檔</h4>
              <div id="recordingSkeletonLoader" class="skeleton-line hidden"></div>
              <audio id="recordedAudioPlayer" controls class="hidden"></audio>
              <div class="log-item" style="margin-top: 15px;">
                <div class="log-icon">🎙️</div>
                <div class="log-content">
                  <div id="recordingLogTitle" class="log-title">高保真錄音</div>
                  <div id="recordingLogDetail" class="log-detail">
                    以 100% 保真度監聽並錄製通話內容。
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 步驟5：音檔存放系統 -->
        <div class="step-section step-idle minimized" id="step-storage">
          <div class="step-header" onclick="toggleStepContent('storage')">
            <div class="step-title">
              <div class="step-number">5</div>
              <span>💾 音檔存放系統</span>
            </div>
            <div class="step-status idle">待機中</div>
          </div>
          <div class="step-content">
            <div class="result-box">
              <h4>音檔歸檔資訊</h4>
              <div class="log-item">
                <div class="log-icon">💾</div>
                <div class="log-content">
                  <div id="storageLogTitle" class="log-title">錄音歸檔</div>
                  <div id="storageLogDetail" class="log-detail">
                    將錄音檔儲存至長期存放系統以供分析。
                  </div>
                </div>
              </div>
              <div id="storageInfo" class="hidden" style="margin-top: 15px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                  <div style="padding: 10px; background: var(--glass-bg); border-radius: 8px;">
                    <div style="font-size: 12px; color: var(--text-dim);">檔案 ID</div>
                    <div id="storageFileId" style="font-weight: 600;">--</div>
                  </div>
                  <div style="padding: 10px; background: var(--glass-bg); border-radius: 8px;">
                    <div style="font-size: 12px; color: var(--text-dim);">存放時間</div>
                    <div id="storageTime" style="font-weight: 600;">--</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 步驟6：分析系統 -->
        <div class="step-section step-idle minimized" id="step-llm-analysis">
          <div class="step-header" onclick="toggleStepContent('llm-analysis')">
            <div class="step-title">
              <div class="step-number">6</div>
              <span>🤖 分析系統</span>
            </div>
            <div class="step-status idle">待機中</div>
          </div>
          <div class="step-content">
            <!-- STT 階段 -->
            <div class="result-box">
              <h4>🎤 語音轉文字 (STT)</h4>
              <!-- <div id="sttProgressBar" class="progress-bar hidden">
                <div id="sttProgressFill" class="progress-fill" style="width: 0%"></div>
              </div> -->
              <div id="sttResult" class="hidden">
                <div style="margin: 15px 0; padding: 15px; background: var(--glass-bg); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 5px;">轉錄文字</div>
                  <div id="transcribedText" style="font-family: monospace; line-height: 1.5;">--</div>
                </div>
                <div style="font-size: 12px; color: var(--text-dim);">
                  置信度: <span id="sttConfidence" style="color: var(--accent-green); font-weight: 600;">--</span>
                </div>
              </div>
            </div>

            <!-- LLM 階段 -->
            <div class="result-box">
              <h4>🤖 智能分析 (LLM)</h4>
              <!-- <div id="llmProgressBar" class="progress-bar hidden">
                <div id="llmProgressFill" class="progress-fill" style="width: 0%"></div>
              </div> -->
              <div id="llmResultContent">
                <div class="skeleton-title skeleton"></div>
                <div class="skeleton-line skeleton"></div>
                <div class="skeleton-line skeleton"></div>
                <div class="skeleton-line skeleton"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- 步驟7：系統結束 -->
        <div class="step-section step-idle minimized" id="step-completion">
          <div class="step-header" onclick="toggleStepContent('completion')">
            <div class="step-title">
              <div class="step-number">7</div>
              <span>🏁 系統結束</span>
            </div>
            <div class="step-status idle">待機中</div>
          </div>
          <div class="step-content">
            <div class="result-box">
              <h4>📊 最終測試報告</h4>
              <div id="finalReportContent">
                <div style="text-align: center; color: var(--text-dim); padding: 40px;">
                  測試完成後將顯示詳細報告
                </div>
              </div>
            </div>
            
            <div class="result-box" style="margin-top: 20px;">
              <h4>📋 測試記錄</h4>
              <button onclick="loadTestHistory()" style="margin-bottom: 15px;">載入測試記錄</button>
              <div id="testHistory">點擊按鈕載入測試記錄...</div>
            </div>
          </div>
        </div>

        <!-- 全域進度條 -->
        <!-- <div id="globalProgressContainer" class="hidden">
          <div class="result-box">
            <h4>🔄 測試進度</h4>
            <div id="globalProgress" class="progress-bar">
              <div id="globalProgressFill" class="progress-fill" style="width: 0%"></div>
            </div>
            <div id="globalProgressStage" class="progress-stage">準備中...</div>
          </div>
        </div> -->

      </div>
    </div>

    <script>
      // 全域狀態管理 - 支援7步驟
      const AppState = {
        currentTestId: null,
        pollInterval: null,
        autoSaveTimer: null,
        theme: localStorage.getItem("theme") || "dark",
        currentStep: "idle",
        stepProgress: 0,
        overallProgress: 0
      };

      // 7步驟架構圖狀態管理
      const ArchitectureState = {
        currentStep: "idle",
        completedSteps: [],
        components: {
          preprocessing: { circle: "circle-preprocessing", arrow: null },
          startup: { circle: "circle-startup", arrow: "arrow-1" },
          "tts-conversion": { circle: "circle-tts-conversion", arrow: "arrow-2" },
          recording: { circle: "circle-recording", arrow: "arrow-3" },
          storage: { circle: "circle-storage", arrow: "arrow-4" },
          "llm-analysis": { circle: "circle-llm-analysis", arrow: "arrow-5" },
          completion: { circle: "circle-completion", arrow: "arrow-6" },
        },
      };

      // 步驟映射（API step 到 前端 step）
      const StepMapping = {
        'idle': 'idle',
        'preprocessing': 'preprocessing',
        'startup': 'startup',
        'tts_conversion': 'tts-conversion',
        'recording': 'recording', 
        'storage': 'storage',
        'llm_analysis': 'llm-analysis',
        'completion': 'completion'
      };

      // 工具函數
      const Utils = {
        sleep: (ms) => new Promise((res) => setTimeout(res, ms)),
        formatNumber: (num) => new Intl.NumberFormat("zh-TW").format(num),
        formatDate: (date) => new Date(date).toLocaleString("zh-TW"),
        formatFileSize: (bytes) => {
          if (bytes === 0) return '0 B';
          const k = 1024;
          const sizes = ['B', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },
        debounce: (func, wait) => {
          let timeout;
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(timeout);
              func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
          };
        },
      };

      function scrollToStep(stepId) {
        const stepElement = document.getElementById(`step-${stepId}`);
        if (stepElement) {
          ArchitectureControl.updateComponentState('preprocessing', 'completed');
          ArchitectureControl.updateComponentState('startup', 'active');
          ArchitectureState.currentStep = 'startup';
          if (!ArchitectureState.completedSteps.includes('preprocessing')) {
            ArchitectureState.completedSteps.push('preprocessing');
          }
          stepElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
          });
          // 自動展開第二步的內容
          if (!stepElement.classList.contains('expanded')) {
            toggleStepContent(stepId);
          }
        }
      }

      // 通知系統
      const NotificationSystem = {
        show: (message, type = "info", duration = 3000) => {
          const toast = document.createElement("div");
          toast.className = `toast toast-${type}`;
          toast.textContent = message;
          document.body.appendChild(toast);

          setTimeout(() => {
            toast.style.animation = "slideInRight 0.3s ease reverse";
            setTimeout(() => document.body.removeChild(toast), 300);
          }, duration);
        },
      };

      // 架構圖控制函數 - 支援圓圈設計
      const ArchitectureControl = {
        // 更新組件狀態
        updateComponentState: (componentId, state) => {
          const component = ArchitectureState.components[componentId];
          if (!component) return;

          const circle = document.getElementById(component.circle);
          const arrow = component.arrow
            ? document.getElementById(component.arrow)
            : null;

          // 更新圓圈狀態
          circle.className = `system-circle ${
            circle.classList.contains("start-end") ? "start-end" : ""
          } ${state}`;

          // 更新箭頭狀態
          if (arrow) {
            arrow.className = `flow-arrow ${state}`;
          }
        },

        // 設定當前活動步驟
        setActiveStep: (stepId) => {
          // 重設所有組件為idle狀態
          Object.keys(ArchitectureState.components).forEach((key) => {
            ArchitectureControl.updateComponentState(key, "idle");
          });

          // 設定已完成的步驟
          ArchitectureState.completedSteps.forEach((step) => {
            ArchitectureControl.updateComponentState(step, "completed");
          });

          // 設定當前活動步驟
          if (stepId && stepId !== "idle") {
            ArchitectureControl.updateComponentState(stepId, "active");
            ArchitectureState.currentStep = stepId;
          }
        },

        // 完成當前步驟
        completeCurrentStep: () => {
          if (ArchitectureState.currentStep !== "idle") {
            ArchitectureState.completedSteps.push(
              ArchitectureState.currentStep
            );
            ArchitectureControl.updateComponentState(
              ArchitectureState.currentStep,
              "completed"
            );
          }
        },

        // 重設流程狀態
        resetFlow: () => {
          ArchitectureState.currentStep = "idle";
          ArchitectureState.completedSteps = [];

          Object.keys(ArchitectureState.components).forEach((key) => {
            ArchitectureControl.updateComponentState(key, "idle");
          });
        },

        // 從後端狀態更新架構圖
        updateFromBackendState: (stateData) => {
          const frontendStep = StepMapping[stateData.current_step] || 'idle';
          
          // 重設所有步驟為 idle
          Object.keys(ArchitectureState.components).forEach((key) => {
            ArchitectureControl.updateComponentState(key, "idle");
          });

          // 設定已完成的步驟
          stateData.completed_steps.forEach((backendStep) => {
            const frontendStepName = StepMapping[backendStep];
            if (frontendStepName) {
              ArchitectureControl.updateComponentState(frontendStepName, "completed");
            }
          });

          // 設定當前活動步驟
          if (frontendStep !== 'idle' && stateData.status !== 'completed') {
            ArchitectureControl.updateComponentState(frontendStep, "active");
          }

          ArchitectureState.currentStep = frontendStep;
          ArchitectureState.completedSteps = stateData.completed_steps.map(step => StepMapping[step]).filter(Boolean);
        }
      };

      // 步驟內容控制
      const StepContentControl = {
        // 切換步驟內容展開/收縮
        toggleStepContent: (stepId) => {
          const section = document.getElementById(`step-${stepId}`);
          if (!section) return;

          if (section.classList.contains('expanded')) {
            section.classList.remove('expanded');
            section.classList.add('minimized');
          } else if (section.classList.contains('minimized')) {
            section.classList.remove('minimized');
            section.classList.add('expanded');
          }
        },

        // 設定步驟狀態
        setStepState: (stepId, state) => {
          const section = document.getElementById(`step-${stepId}`);
          const statusElement = section?.querySelector('.step-status');
          if (!section || !statusElement) return;

          // 更新區塊狀態類別
          section.className = section.className.replace(/step-(idle|active|completed)/g, '');
          section.classList.add(`step-${state}`);

          // 更新狀態文字和樣式
          statusElement.className = `step-status ${state}`;
          
          switch (state) {
            case 'idle':
              statusElement.textContent = '待機中';
              break;
            case 'active':
              statusElement.innerHTML = '<div class="loading-spinner"></div>處理中...';
              break;
            case 'completed':
              statusElement.textContent = '✓ 已完成';
              break;
          }

          // 自動調整展開狀態
          if (state === 'active') {
            section.classList.remove('minimized');
            section.classList.add('expanded');
          } else if (state === 'completed') {
            section.classList.remove('expanded');
            section.classList.add('summary');
          }
        },

        // 從後端狀態更新所有步驟
        updateFromBackendState: (stateData) => {
          const allSteps = ['preprocessing', 'startup', 'tts-conversion', 'recording', 'storage', 'llm-analysis', 'completion'];
          
          allSteps.forEach(stepId => {
            const backendStepId = Object.keys(StepMapping).find(key => StepMapping[key] === stepId);
            
            if (stateData.completed_steps.includes(backendStepId)) {
              StepContentControl.setStepState(stepId, 'completed');
            } else if (StepMapping[stateData.current_step] === stepId) {
              StepContentControl.setStepState(stepId, 'active');
            } else {
              StepContentControl.setStepState(stepId, 'idle');
            }
          });
        }
      };

      // 初始化浮動粒子
      function initParticles() {
        const particleCount = 15;
        const particles = document.getElementById("particles");

        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement("div");
          particle.className = "particle";
          particle.style.left = `${Math.random() * 100}%`;
          const size = Math.random() * 4 + 2;
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;
          particle.style.animationDelay = `${Math.random() * 15}s`;
          particle.style.animationDuration = `${Math.random() * 10 + 12}s`;
          particles.appendChild(particle);
        }
      }

      // 主題切換
      function toggleTheme() {
        const body = document.body;
        const themeToggle = document.getElementById("themeToggle");
        const themeLabel = document.getElementById("themeLabel");
        const currentTheme = body.dataset.theme;

        if (currentTheme === "dark") {
          body.dataset.theme = "light";
          themeToggle.classList.remove("dark");
          themeLabel.textContent = "LIGHT";
          AppState.theme = "light";
        } else {
          body.dataset.theme = "dark";
          themeToggle.classList.add("dark");
          themeLabel.textContent = "DARK";
          AppState.theme = "dark";
        }

        localStorage.setItem("theme", AppState.theme);
        NotificationSystem.show(
          `已切換至${AppState.theme === "dark" ? "深色" : "淺色"}模式`,
          "success"
        );
      }

      // 初始化主題
      function initTheme() {
        const body = document.body;
        const themeToggle = document.getElementById("themeToggle");
        const themeLabel = document.getElementById("themeLabel");

        body.dataset.theme = AppState.theme;

        if (AppState.theme === "dark") {
          themeToggle.classList.add("dark");
          themeLabel.textContent = "DARK";
        } else {
          themeToggle.classList.remove("dark");
          themeLabel.textContent = "LIGHT";
        }
      }

      // 字數統計和對話計數
      function updateCharCount() {
        const textarea = document.getElementById("testScript");
        const charCount = document.getElementById("charCount");
        const dialogueCount = document.getElementById("dialogueCount");
        
        const content = textarea.value;
        const charCountValue = content.length;
        
        // 計算對話行數
        const lines = content.trim().split("\n");
        let dialogueLines = 0;
        for (const line of lines) {
          if (line.includes(":") && (line.includes("客戶") || line.includes("客服") || line.includes("customer") || line.includes("agent"))) {
            dialogueLines++;
          }
        }
        
        charCount.textContent = `${Utils.formatNumber(charCountValue)} 字元`;
        dialogueCount.textContent = `${dialogueLines} 行對話`;

        // 顏色提示
        if (charCountValue > 1000) {
          charCount.style.color = "#e84393";
        } else if (charCountValue > 500) {
          charCount.style.color = "var(--accent-cyan)";
        } else {
          charCount.style.color = "var(--accent-green)";
        }

        // 當有內容時激活前置作業狀態
        if (charCountValue > 0 && ArchitectureState.currentStep === "idle") {
          ArchitectureControl.setActiveStep("preprocessing");
          StepContentControl.setStepState('preprocessing', 'active');
        }
      }

      // 自動儲存
      const autoSave = Utils.debounce(() => {
        const script = document.getElementById("testScript").value;
        localStorage.setItem("saved_script", script);

        const indicator = document.getElementById("autoSaveIndicator");
        indicator.classList.add("visible");
        setTimeout(() => indicator.classList.remove("visible"), 2000);
      }, 1000);

      // 載入已儲存的腳本
      function loadSavedScript() {
        const saved = localStorage.getItem("saved_script");
        if (saved) {
          document.getElementById("testScript").value = saved;
          updateCharCount();
        }
      }

      // 拖拽檔案處理
      function initDragAndDrop() {
        const textarea = document.getElementById("testScript");
        const overlay = document.getElementById("dragOverlay");

        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          textarea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ["dragenter", "dragover"].forEach((eventName) => {
          textarea.addEventListener(
            eventName,
            () => {
              overlay.classList.add("active");
            },
            false
          );
        });

        ["dragleave", "drop"].forEach((eventName) => {
          textarea.addEventListener(
            eventName,
            () => {
              overlay.classList.remove("active");
            },
            false
          );
        });

        textarea.addEventListener("drop", handleDrop, false);

        function handleDrop(e) {
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            const file = files[0];
            if (file.type === "text/plain") {
              const reader = new FileReader();
              reader.onload = (e) => {
                textarea.value = e.target.result;
                updateCharCount();
                autoSave();
                NotificationSystem.show("檔案已成功載入", "success");
              };
              reader.readAsText(file);
            } else {
              NotificationSystem.show("請選擇文字檔案 (.txt)", "error");
            }
          }
        }
      }

      // 步驟內容切換函數（全域）
      function toggleStepContent(stepId) {
        StepContentControl.toggleStepContent(stepId);
      }

      // 進度條更新
      // function updateGlobalProgress(percentage, stage = "") {
      //   const progressContainer = document.getElementById("globalProgressContainer");
      //   const progressFill = document.getElementById("globalProgressFill");
      //   const progressStage = document.getElementById("globalProgressStage");

      //   if (percentage === 0) {
      //     progressContainer.classList.add("hidden");
      //   } else {
      //     progressContainer.classList.remove("hidden");
      //     progressFill.style.width = `${percentage}%`;
          
      //     if (stage) {
      //       progressStage.textContent = stage;
      //     } else {
      //       progressStage.textContent = `整體進度: ${percentage.toFixed(1)}%`;
      //     }
      //   }
      // }

      // 開始測試
      async function startTest() {
        const script = document.getElementById("testScript").value.trim();
        if (!script) {
          NotificationSystem.show("請輸入測試腳本", "error");
          document.getElementById("testScript").style.animation = "shake 0.5s ease";
          return;
        }

        const startBtn = document.getElementById("startTestBtn");
        
        startBtn.disabled = true;
        startBtn.innerHTML = '<div class="loading-spinner"></div>執行中...';
        
        // 顯示全域進度條
        // updateGlobalProgress(10, "測試啟動中...");

        try {
          const response = await fetch("/api/test/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ script: script }),
          });

          if (!response.ok)
            throw new Error(`伺服器錯誤: ${response.statusText}`);

          const data = await response.json();
          AppState.currentTestId = data.test_id;
          
          NotificationSystem.show("測試已成功啟動", "success");

          // 開始輪詢
          startPolling();
        } catch (error) {
          startBtn.disabled = false;
          startBtn.innerHTML = "開始測試";
          // updateGlobalProgress(0);
          NotificationSystem.show("測試啟動失敗", "error");
          ArchitectureControl.resetFlow();
          console.error("測試啟動失敗:", error);
        }
      }

      // 輪詢測試狀態
      function startPolling() {
        if (AppState.pollInterval) clearInterval(AppState.pollInterval);

        AppState.pollInterval = setInterval(async () => {
          if (!AppState.currentTestId) return;

          try {
            const response = await fetch(`/api/test/${AppState.currentTestId}/status`);
            const stateData = await response.json();

            // 更新全域狀態
            AppState.currentStep = stateData.current_step;
            AppState.stepProgress = stateData.step_progress;
            AppState.overallProgress = stateData.overall_progress;

            // 同步架構圖和步驟區塊
            ArchitectureControl.updateFromBackendState(stateData);
            StepContentControl.updateFromBackendState(stateData);

            // 更新全域進度
            // updateGlobalProgress(stateData.overall_progress, stateData.step_details.step_description);

            // 根據當前步驟更新詳細內容
            await updateStepDetails(stateData);

            // 檢查是否完成
            if (stateData.status === "completed" || stateData.status === "failed") {
              clearInterval(AppState.pollInterval);
              
              const startBtn = document.getElementById("startTestBtn");
              startBtn.disabled = false;
              startBtn.innerHTML = "開始測試";

              if (stateData.status === "completed") {
                await loadTestResult(AppState.currentTestId);
                NotificationSystem.show("測試完成！", "success");
              } else {
                NotificationSystem.show("測試失敗", "error");
                // updateGlobalProgress(0);
              }
            }

          } catch (error) {
            console.error("輪詢錯誤:", error);
            clearInterval(AppState.pollInterval);
            NotificationSystem.show("狀態查詢失敗", "error");
          }
        }, 2000); // 每2秒輪詢一次
      }

      // 更新步驟詳細內容
      async function updateStepDetails(stateData) {
        const currentStep = stateData.current_step;
        
        // 根據當前步驟更新對應區塊的詳細內容
        switch (currentStep) {
          case 'startup':
            await updateStartupDetails(stateData);
            break;
          case 'tts_conversion':
            await updateTtsDetails(stateData);
            break;
          case 'recording':
            await updateRecordingDetails(stateData);
            break;
          case 'storage':
            await updateStorageDetails(stateData);
            break;
          case 'llm_analysis':
            // await updateLlmDetails(stateData);
            break;
          case 'completion':
            await updateCompletionDetails(stateData);
            break;
        }
      }

      // 更新系統啟動詳細資訊
      async function updateStartupDetails(stateData) {
        // 這裡可以根據 stateData 更新 API 狀態
        // 目前保持簡單的狀態顯示
      }

      // 更新 TTS 詳細資訊
      async function updateTtsDetails(stateData) {
        if (stateData.step_progress >= 50) {
          // TTS 處理中或完成，可以嘗試載入音檔
        }
      }

      // 更新錄音詳細資訊
      async function updateRecordingDetails(stateData) {
        const logTitle = document.getElementById("recordingLogTitle");
        const logDetail = document.getElementById("recordingLogDetail");
        
        if (stateData.step_progress > 0 && stateData.step_progress < 100) {
          logTitle.innerHTML = '高保真錄音 <span style="color: var(--text-dim);">[錄製中...]</span>';
          logDetail.textContent = "正在進行高保真錄音...";
        } else if (stateData.step_progress === 100) {
          logTitle.innerHTML = '高保真錄音 <span style="color: var(--accent-green); font-weight: 600;">[完成]</span>';
          logDetail.textContent = "以 100% 保真度監聽並錄製通話內容。";
        }
      }

      // 更新存放詳細資訊
      async function updateStorageDetails(stateData) {
        const logTitle = document.getElementById("storageLogTitle");
        const logDetail = document.getElementById("storageLogDetail");
        
        if (stateData.step_progress > 0 && stateData.step_progress < 100) {
          logTitle.innerHTML = '錄音歸檔 <span style="color: var(--text-dim);">[歸檔中...]</span>';
          logDetail.textContent = "正在將錄音檔存放至系統...";
        } else if (stateData.step_progress === 100) {
          logTitle.innerHTML = '錄音歸檔 <span style="color: var(--accent-green); font-weight: 600;">[完成]</span>';
          logDetail.textContent = "將錄音檔儲存至長期存放系統以供分析。";
        }
      }

      // 更新 LLM 分析詳細資訊
      // async function updateLlmDetails(stateData) {
      //   const sttProgressBar = document.getElementById("sttProgressBar");
      //   const sttProgressFill = document.getElementById("sttProgressFill");
      //   const llmProgressBar = document.getElementById("llmProgressBar");
      //   const llmProgressFill = document.getElementById("llmProgressFill");

      //   if (stateData.step_progress <= 50) {
      //     // STT 階段
      //     sttProgressBar.classList.remove("hidden");
      //     sttProgressFill.style.width = `${(stateData.step_progress / 50) * 100}%`;
      //   } else {
      //     // LLM 階段
      //     sttProgressBar.classList.add("hidden");
      //     llmProgressBar.classList.remove("hidden");
      //     llmProgressFill.style.width = `${((stateData.step_progress - 50) / 50) * 100}%`;
      //   }
      // }

      // 更新系統結束詳細資訊
      async function updateCompletionDetails(stateData) {
        // 系統結束階段的詳細更新
      }

      // 載入測試結果
      async function loadTestResult(testId) {
        try {
          const response = await fetch(`/api/test/${testId}/result`);
          if (!response.ok) throw new Error("無法獲取測試結果");
          const data = await response.json();

          // 載入各個步驟的結果
          await loadTtsAudio(data);
          await loadRecordedAudio(data);
          await loadStorageInfo(data);
          await renderLlmResults(data);
          await renderFinalReport(data);

          // 隱藏全域進度條
          // setTimeout(() => updateGlobalProgress(0), 2000);

        } catch (error) {
          console.error("載入測試結果失敗:", error);
          NotificationSystem.show("結果載入失敗", "error");
          // updateGlobalProgress(0);
        }
      }

      // 載入 TTS 音檔
      async function loadTtsAudio(data) {
        if (data.tts_audio) {
          const audioPlayer = document.getElementById("ttsAudioPlayer");
          const audioInfo = document.getElementById("ttsAudioInfo");
          const durationSpan = document.getElementById("ttsAudioDuration");
          const sizeSpan = document.getElementById("ttsAudioSize");
          
          document.getElementById("ttsSkeletonLoader").classList.add("hidden");
          
          audioPlayer.src = data.tts_audio.web_path;
          audioPlayer.classList.remove("hidden");
          
          durationSpan.textContent = `時長: ${data.tts_audio.duration.toFixed(1)}s`;
          sizeSpan.textContent = `大小: ${Utils.formatFileSize(data.tts_generation_info?.file_size || 0)}`;
          audioInfo.classList.remove("hidden");
        }
      }

      // 載入錄音音檔
      async function loadRecordedAudio(data) {
        if (data.recorded_audio) {
          const audioPlayer = document.getElementById("recordedAudioPlayer");
          
          document.getElementById("recordingSkeletonLoader").classList.add("hidden");
          
          audioPlayer.src = data.recorded_audio.web_path;
          audioPlayer.classList.remove("hidden");
        }
      }

      // 載入存放資訊
      async function loadStorageInfo(data) {
        if (data.storage_file_id) {
          const storageInfo = document.getElementById("storageInfo");
          const fileIdSpan = document.getElementById("storageFileId");
          const timeSpan = document.getElementById("storageTime");
          
          fileIdSpan.textContent = data.storage_file_id.substring(0, 8) + "...";
          timeSpan.textContent = Utils.formatDate(data.storage_metadata?.stored_at || new Date());
          
          storageInfo.classList.remove("hidden");
        }
      }

      // 渲染 LLM 結果
      async function renderLlmResults(data) {
        const llmResultContent = document.getElementById("llmResultContent");
        const sttResult = document.getElementById("sttResult");
        const transcribedText = document.getElementById("transcribedText");
        const sttConfidence = document.getElementById("sttConfidence");

        // 顯示 STT 結果
        if (data.transcribed_text) {
          transcribedText.textContent = data.transcribed_text;
          sttConfidence.textContent = `${(data.stt_confidence * 100).toFixed(1)}%`;
          sttResult.classList.remove("hidden");
        }

        // 顯示 LLM 分析結果
        const analysis = data.llm_analysis;
        const score = analysis?.accuracy_score || 0;

        let scoreClass = "score-excellent";
        if (score < 60) scoreClass = "score-poor";
        else if (score < 80) scoreClass = "score-fair";
        else if (score < 90) scoreClass = "score-good";

        let resultHtml = `<div class="score ${scoreClass}">準確率: ${score.toFixed(1)}%</div>`;

        if (analysis?.reasoning) {
          resultHtml += `<div class="result-box fade-enter"><strong>📝 分析摘要:</strong><br>${analysis.reasoning}</div>`;
        }

        if (analysis?.key_differences?.length > 0) {
          resultHtml += '<div class="result-box fade-enter no-bullets"><strong>🔍 主要差異:</strong><ul>';
          analysis.key_differences.forEach((diff) => {
            
            let diffText = '';
            if (typeof diff === 'object' && diff !== null) {
              diffText = Object.values(diff)[0] || JSON.stringify(diff);
            } else {
              diffText = diff;
            }

            resultHtml += `<li>• ${diffText}</li>`;
          });
          resultHtml += "</ul></div>";
        }

        if (analysis?.suggestions?.length > 0) {
          resultHtml += '<div class="result-box fade-enter no-bullets"><strong>💡 改進建議:</strong><ul>';
          analysis.suggestions.forEach((sugg) => {
            resultHtml += `<li>• ${sugg}</li>`;
          });
          resultHtml += "</ul></div>";
        }

        llmResultContent.innerHTML = resultHtml;
      }

      // 渲染最終報告
      async function renderFinalReport(data) {
        const finalReportContent = document.getElementById("finalReportContent");
        
        const report = data.final_report?.test_summary || {};
        const executionSummary = data.execution_summary || {};
        
        let reportHtml = `
          <div class="result-box fade-enter">
            <h4>📊 測試執行摘要</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
              <div style="text-align: center; padding: 15px; background: var(--glass-bg); border-radius: 8px;">
                <div style="font-size: 24px; font-weight: 700; color: var(--accent-green);">${executionSummary.completed_steps || 7}</div>
                <div style="font-size: 12px; color: var(--text-dim);">完成步驟</div>
              </div>
              <div style="text-align: center; padding: 15px; background: var(--glass-bg); border-radius: 8px;">
                <div style="font-size: 24px; font-weight: 700; color: var(--accent-cyan);">${(data.accuracy_score || 0).toFixed(1)}%</div>
                <div style="font-size: 12px; color: var(--text-dim);">準確率</div>
              </div>
              <div style="text-align: center; padding: 15px; background: var(--glass-bg); border-radius: 8px;">
                <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(report.total_duration_seconds || 0).toFixed(1)}s</div>
                <div style="font-size: 12px; color: var(--text-dim);">總時長</div>
              </div>
            </div>
          </div>
        `;

        // 添加對比面板
        reportHtml += `
          <div class="result-box fade-enter" style="margin-top: 20px;">
            <h4>📜 對話內容比較</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
              <div>
                <h5 style="color: var(--accent-green); margin-bottom: 10px;">原始腳本</h5>
                <div style="padding: 15px; background: var(--glass-bg); border-radius: 8px; font-family: monospace; font-size: 12px; line-height: 1.5; max-height: 200px; overflow-y: auto;">
                  ${data.original_script || '--'}
                </div>
              </div>
              <div>
                <h5 style="color: var(--accent-cyan); margin-bottom: 10px;">轉錄結果</h5>
                <div style="padding: 15px; background: var(--glass-bg); border-radius: 8px; font-family: monospace; font-size: 12px; line-height: 1.5; max-height: 200px; overflow-y: auto;">
                  ${data.transcribed_text || '--'}
                </div>
              </div>
            </div>
          </div>
        `;

        finalReportContent.innerHTML = reportHtml;
      }

      // 載入測試記錄
      async function loadTestHistory() {
        const historyDiv = document.getElementById("testHistory");
        historyDiv.innerHTML = '<div class="loading-spinner"></div>正在載入測試記錄...';

        try {
          const response = await fetch("/api/tests/list?limit=5");
          const data = await response.json();

          if (data.tests.length === 0) {
            historyDiv.innerHTML = "<p>目前沒有測試記錄</p>";
            return;
          }

          let historyHtml = `<p>共 ${Utils.formatNumber(data.total)} 個測試記錄，顯示最近 ${data.tests.length} 個:</p>`;
          historyHtml += '<div style="display: flex; flex-direction: column; gap: 15px;">';

          data.tests.forEach((test, index) => {
            const statusIcon = test.status === "completed" ? "✅" : test.status === "failed" ? "❌" : "🔄";
            const scoreColor = test.accuracy_score >= 80 ? "var(--accent-green)" : test.accuracy_score >= 60 ? "var(--accent-cyan)" : "#e84393";

            historyHtml += `
              <div class="result-box fade-enter" style="animation-delay: ${index * 0.1}s;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                  <div>
                    ${statusIcon} <strong>ID:</strong> ${test.test_id.substring(0, 8)}...
                    <span style="color: ${scoreColor}; font-weight: 600; margin-left: 10px;">
                      ${test.accuracy_score.toFixed(1)}%
                    </span>
                  </div>
                  <div style="color: var(--text-dim); font-size: 12px;">
                    ${Utils.formatDate(test.timestamp)}
                  </div>
                </div>
                <div style="font-size: 14px; color: var(--text-dim); margin-bottom: 10px;">
                  ${test.script_preview}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="font-size: 12px; color: var(--text-dim);">
                    步驟: ${test.completed_steps_count}/${test.total_steps} | 
                    當前: ${test.current_step_name}
                  </div>
                  ${
                    test.status === "completed"
                      ? `<button onclick="loadTestResult('${test.test_id}')" style="padding: 6px 12px; font-size: 12px;">查看結果</button>`
                      : ""
                  }
                </div>
              </div>
            `;
          });

          historyHtml += "</div>";
          historyDiv.innerHTML = historyHtml;
        } catch (error) {
          historyDiv.innerHTML = `<div class="status status-error">載入測試記錄失敗: ${error.message}</div>`;
          NotificationSystem.show("記錄載入失敗", "error");
        }
      }

      // 系統狀態檢查
      async function checkSystemStatus() {
        try {
          const response = await fetch("/api/system/status");
          const data = await response.json();

          // 更新 API 狀態顯示
          const ttsStatus = document.getElementById("ttsApiStatus");
          const sttStatus = document.getElementById("sttApiStatus");
          const llmStatus = document.getElementById("llmApiStatus");

          const sttApiTitle = document.getElementById("sttApiTitle");
          const llmApiTitle = document.getElementById("llmApiTitle");

          const updateApiStatus = (element, isHealthy) => {
            if (isHealthy) {
              element.textContent = "✅ 連線正常";
              element.style.color = "var(--accent-green)";
            } else {
              element.textContent = "❌ 連線失敗";
              element.style.color = "#e84393";
            }
          };

          updateApiStatus(ttsStatus, data.services["tts (yating)"]);
          const sttServiceKey = Object.keys(data.services).find(key => key.startsWith("stt ("));

          if (sttServiceKey) {
            const modelName = sttServiceKey.match(/\((.*?)\)/)[1];
            sttApiTitle.textContent = `STT API (${modelName})`;
            updateApiStatus(sttStatus, data.services[sttServiceKey]);
          } else {
            sttApiTitle.textContent = "STT API";
            updateApiStatus(sttStatus, false);
          }

          const llmServiceKey = Object.keys(data.services).find(key => key.startsWith("llm ("));
          if (llmServiceKey) {
            const modelName = llmServiceKey.match(/\((.*?)\)/)[1];
            llmApiTitle.textContent = `LLM API (${modelName})`;
            updateApiStatus(llmStatus, data.services[llmServiceKey]);
          } else {
            llmApiTitle.textContent = "LLM API";
            updateApiStatus(llmStatus, false);
          }

          const overallStatus = data.status === "healthy";
          NotificationSystem.show(
            overallStatus ? "系統運行正常" : "系統狀態異常",
            overallStatus ? "success" : "error"
          );

        } catch (error) {
          const errorElements = [
            document.getElementById("ttsApiStatus"),
            document.getElementById("sttApiStatus"),
            document.getElementById("llmApiStatus")
          ];

          errorElements.forEach(element => {
            element.textContent = "❌ 檢查失敗";
            element.style.color = "#e84393";
          });

          NotificationSystem.show("系統狀態檢查失敗", "error");
        }
      }

      // 頁面載入時初始化
      window.onload = function () {
        initTheme();
        initParticles();
        loadSavedScript();
        initDragAndDrop();
        ArchitectureControl.resetFlow();
        
        // 初始化步驟區塊狀態
        const allSteps = ['preprocessing', 'startup', 'tts-conversion', 'recording', 'storage', 'llm-analysis', 'completion'];
        allSteps.forEach((stepId, index) => {
          if (index === 0) {
            StepContentControl.setStepState(stepId, 'idle');
            // 第一個步驟默認展開
            const section = document.getElementById(`step-${stepId}`);
            if (section) section.classList.add('expanded');
          } else {
            StepContentControl.setStepState(stepId, 'idle');
            // 其他步驟默認最小化
            const section = document.getElementById(`step-${stepId}`);
            if (section) section.classList.add('minimized');
          }
        });

        // 檢查系統狀態
        checkSystemStatus();
        
        // 載入測試記錄
        loadTestHistory();

        // 綁定事件監聽器
        const textarea = document.getElementById("testScript");
        if (textarea) {
          textarea.addEventListener("input", () => {
            updateCharCount();
            autoSave();
          });
        }

        updateCharCount();
        NotificationSystem.show("系統已準備就緒", "success");
      };

      // 清理資源
      window.onbeforeunload = function () {
        if (AppState.pollInterval) clearInterval(AppState.pollInterval);
        if (AppState.autoSaveTimer) clearTimeout(AppState.autoSaveTimer);
      };

      // 全域函數暴露（供 HTML 調用）
      window.toggleTheme = toggleTheme;
      window.startTest = startTest;
      window.loadTestHistory = loadTestHistory;
      window.checkSystemStatus = checkSystemStatus;
      window.toggleStepContent = toggleStepContent;
      window.loadTestResult = loadTestResult;
      window.scrollToStep = scrollToStep;
    </script>
  </body>
</html>
    </script>
  </body>
</html>